<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crafe Sohbet</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #0056b3;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --gray-color: #6c757d;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            color: #333;
        }

        .chat-container {
            display: flex;
            width: 95%;
            max-width: 1200px;
            height: 90vh;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .sidebar {
            width: 280px;
            background: rgba(248, 249, 250, 0.95);
            padding: 20px;
            border-right: 1px solid #dee2e6;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #dee2e6;
        }

        .sidebar-header h2 {
            margin: 0;
            color: var(--dark-color);
            font-size: 22px;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            margin: 0;
            color: var(--gray-color);
            font-size: 14px;
        }

        .user-status {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 5px;
            font-size: 12px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success-color);
            margin-right: 5px;
        }

        .friends-container {
            flex: 1;
            overflow-y: auto;
            margin: 15px 0;
        }

        .section-title {
            font-size: 14px;
            color: var(--gray-color);
            margin: 15px 0 8px;
            padding-bottom: 5px;
            border-bottom: 1px solid #dee2e6;
        }

        .friends-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .friends-list li {
            padding: 12px 15px;
            margin-bottom: 8px;
            background: var(--primary-color);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .friends-list li:hover {
            background: var(--secondary-color);
            transform: translateX(5px);
        }

        .friends-list li.active {
            background: var(--secondary-color);
            box-shadow: 0 0 12px rgba(0, 123, 255, 0.4);
        }

        .friend-info {
            display: flex;
            align-items: center;
        }

        .friend-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
        }

        .friend-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success-color);
        }

        .friend-actions {
            display: flex;
            align-items: center;
        }

        .remove-friend {
            background: none;
            border: none;
            color: #ff6b6b;
            cursor: pointer;
            opacity: 0.7;
            margin-left: 8px;
            font-size: 14px;
            padding: 5px;
            border-radius: 4px;
        }

        .remove-friend:hover {
            opacity: 1;
            background: rgba(255, 107, 107, 0.1);
        }

        .requests-list {
            list-style: none;
            padding: 0;
            margin: 0 0 15px 0;
        }

        .request-item {
            padding: 10px;
            margin-bottom: 8px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .request-actions {
            display: flex;
            gap: 5px;
        }

        .request-actions button {
            border: none;
            border-radius: 4px;
            padding: 5px 8px;
            cursor: pointer;
            font-size: 12px;
        }

        .accept-btn {
            background: var(--success-color);
            color: white;
        }

        .reject-btn {
            background: var(--danger-color);
            color: white;
        }

        .add-friend-container {
            padding: 15px 0;
            border-top: 1px solid #dee2e6;
        }

        .add-friend-container input {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            border: 1px solid #ced4da;
            box-sizing: border-box;
            font-size: 14px;
        }

        .add-friend-container button {
            width: 100%;
            padding: 12px;
            background: var(--success-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
            font-weight: bold;
        }

        .add-friend-container button:hover {
            background: #218838;
        }

        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: var(--primary-color);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .chat-title {
            font-size: 18px;
            font-weight: bold;
        }

        .chat-actions button {
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            margin-left: 10px;
            font-size: 16px;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            max-width: 80%;
        }

        .message-content {
            padding: 12px 16px;
            border-radius: 18px;
            margin-bottom: 5px;
            position: relative;
            word-break: break-word;
        }

        .message.sent {
            align-items: flex-end;
            align-self: flex-end;
        }

        .message.received {
            align-items: flex-start;
            align-self: flex-start;
        }

        .message.sent .message-content {
            background: var(--primary-color);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message.received .message-content {
            background: #e9e9e9;
            color: #333;
            border-bottom-left-radius: 5px;
        }

        .message-info {
            font-size: 11px;
            color: var(--gray-color);
            padding: 0 8px;
            display: flex;
            justify-content: space-between;
        }

        .chat-input {
            display: flex;
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
        }

        .chat-input input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ced4da;
            border-radius: 25px;
            margin-right: 10px;
            font-size: 14px;
            outline: none;
        }

        .chat-input button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: background 0.3s;
            font-weight: bold;
        }

        .chat-input button:hover {
            background: var(--secondary-color);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            color: white;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s;
        }

        .notification.success {
            background: var(--success-color);
        }

        .notification.error {
            background: var(--danger-color);
        }

        .notification.warning {
            background: var(--warning-color);
        }

        .notification.show {
            transform: translateX(0);
        }

        .empty-state {
            text-align: center;
            color: var(--gray-color);
            padding: 40px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            color: #adb5bd;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            font-weight: normal;
        }

        .empty-state p {
            color: var(--gray-color);
            line-height: 1.5;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }

        .modal-body {
            margin-bottom: 15px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .modal-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .modal-btn.primary {
            background: var(--primary-color);
            color: white;
        }

        .modal-btn.secondary {
            background: var(--gray-color);
            color: white;
        }

        /* Mobil Görünüm İyileştirmeleri */
        @media (max-width: 768px) {
            .chat-container {
                flex-direction: column;
                height: 100vh;
                width: 100%;
                border-radius: 0;
                position: fixed;
                top: 0;
                left: 0;
            }
            
            .sidebar {
                width: 100%;
                height: 40vh; /* Daha iyi bir yükseklik */
                min-height: 250px; /* Minimum yükseklik */
                padding: 15px;
                overflow-y: auto;
                order: 2; /* Alt kısma taşı */
            }
            
            .chat-main {
                width: 100%;
                height: 60vh; /* Daha dengeli yükseklik */
                order: 1; /* Üst kısma taşı */
            }
            
            .message {
                max-width: 90%;
            }
            
            /* Arkadaş ekleme alanını daha görünür yap */
            .add-friend-container {
                position: sticky;
                bottom: 0;
                background: rgba(248, 249, 250, 0.95);
                padding: 10px 0;
                margin-top: 10px;
                border-top: 1px solid #dee2e6;
            }
            
            .friends-container {
                max-height: calc(100% - 150px); /* Arkadaş ekleme alanı için yer bırak */
                overflow-y: auto;
            }
            
            /* Başlık boyutlarını küçült */
            .sidebar-header h2 {
                font-size: 18px;
            }
            
            .chat-title {
                font-size: 16px;
            }
            
            /* Mesaj alanını optimize et */
            .chat-messages {
                padding: 15px;
            }
            
            .chat-input {
                padding: 10px 15px;
            }
            
            .chat-input input {
                padding: 10px 12px;
                font-size: 14px;
            }
            
            .chat-input button {
                padding: 10px 15px;
            }
        }

        /* Çok küçük ekranlar için ek iyileştirmeler */
        @media (max-width: 480px) {
            .sidebar {
                height: 45vh; /* Daha fazla alan */
                min-height: 280px;
            }
            
            .chat-main {
                height: 55vh;
            }
            
            .sidebar-header h2 {
                font-size: 16px;
            }
            
            .sidebar-header p {
                font-size: 12px;
            }
            
            .friends-list li {
                padding: 10px 12px;
                font-size: 14px;
            }
            
            .friend-avatar {
                width: 28px;
                height: 28px;
                font-size: 14px;
            }
            
            .add-friend-container input {
                padding: 10px;
                font-size: 14px;
            }
            
            .add-friend-container button {
                padding: 10px;
                font-size: 14px;
            }
            
            .chat-header {
                padding: 10px 15px;
            }
            
            .chat-title {
                font-size: 14px;
            }
            
            .chat-actions button {
                font-size: 14px;
                margin-left: 8px;
            }
        }

        /* Yatay modda telefonlar için */
        @media (max-width: 768px) and (orientation: landscape) {
            .chat-container {
                flex-direction: row; /* Yatay modda yan yana göster */
            }
            
            .sidebar {
                width: 40%;
                height: 100vh;
                order: 1;
            }
            
            .chat-main {
                width: 60%;
                height: 100vh;
                order: 2;
            }
            
            .friends-container {
                max-height: calc(100% - 200px);
            }
        }

        /* Scrollbar stilleri */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c5c5c5;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a5a5a5;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>Crafe Sohbet</h2>
                <p id="userInfo">Kullanıcı: Yükleniyor...</p>
                <div class="user-status">
                    <span class="status-indicator"></span>
                    <span>Çevrimiçi</span>
                </div>
            </div>
            <div class="friends-container">
                <div class="section-title">Arkadaşlık İstekleri</div>
                <ul class="requests-list" id="requestsList"></ul>
                
                <div class="section-title">Arkadaşlar</div>
                <ul class="friends-list" id="friendsList"></ul>
            </div>
            <div class="add-friend-container">
                <input type="text" id="friendUsername" placeholder="Kullanıcı adı ile arkadaş ekle" />
                <button id="addFriendButton">İstek Gönder</button>
            </div>
        </div>
        <div class="chat-main">
            <div class="chat-header">
                <div class="chat-title" id="chatHeader">Sohbet Başlat</div>
                <div class="chat-actions">
                    <button id="clearChatButton" title="Sohbeti Temizle"><i class="fas fa-trash"></i></button>
                    <button id="refreshButton" title="Yenile"><i class="fas fa-sync-alt"></i></button>
                </div>
            </div>
            <div class="chat-messages" id="messages">
                <div class="empty-state" id="emptyState">
                    <div><i class="fas fa-comments"></i></div>
                    <h3>Henüz mesaj yok</h3>
                    <p>Bir sohbet başlatmak için soldan bir arkadaş seçin ve mesaj gönderin.</p>
                </div>
            </div>
            <div class="chat-input">
                <input type="text" id="messageInput" placeholder="Mesajınızı yazın..." />
                <button id="sendButton">Gönder</button>
            </div>
        </div>
    </div>

    <div class="notification" id="notification">İşlem başarılı!</div>

    <div class="modal" id="userSearchModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Kullanıcı Doğrulama</div>
                <button class="close-modal" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <p id="modalMessage">Kullanıcı bulunamadı. İstek göndermek istiyor musunuz?</p>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" id="modalCancel">İptal</button>
                <button class="modal-btn primary" id="modalConfirm">Onayla</button>
            </div>
        </div>
    </div>

    <script>
        // DOM elementleri
        const messagesDiv = document.getElementById("messages");
        const messageInput = document.getElementById("messageInput");
        const sendButton = document.getElementById("sendButton");
        const addFriendButton = document.getElementById("addFriendButton");
        const friendUsernameInput = document.getElementById("friendUsername");
        const friendsList = document.getElementById("friendsList");
        const requestsList = document.getElementById("requestsList");
        const chatHeader = document.getElementById("chatHeader");
        const userInfo = document.getElementById("userInfo");
        const notification = document.getElementById("notification");
        const emptyState = document.getElementById("emptyState");
        const clearChatButton = document.getElementById("clearChatButton");
        const refreshButton = document.getElementById("refreshButton");
        const userSearchModal = document.getElementById("userSearchModal");
        const closeModal = document.getElementById("closeModal");
        const modalCancel = document.getElementById("modalCancel");
        const modalConfirm = document.getElementById("modalConfirm");
        const modalMessage = document.getElementById("modalMessage");

        // URL parametrelerini al
        const urlParams = new URLSearchParams(window.location.search);
        let username = urlParams.get('username');
        let currentFriend = urlParams.get('friend');

        // Kullanıcı adı yoksa varsayılan değer ata
        if (!username) {
            username = "Misafir_" + Math.floor(Math.random() * 10000);
            // URL'i güncelle
            const newUrl = window.location.origin + window.location.pathname + '?username=' + username;
            window.history.replaceState({}, '', newUrl);
        }

        // Kullanıcı bilgisini göster
        userInfo.textContent = `Kullanıcı: ${username}`;

        // LocalStorage'dan kullanıcı verilerini al veya oluştur
        let usersData = JSON.parse(localStorage.getItem('usersData')) || {};
        if (!usersData[username]) {
            usersData[username] = { 
                friends: [], 
                messages: {}, 
                friendRequests: [],
                sentRequests: []
            };
        }
        let friends = usersData[username].friends;
        let friendRequests = usersData[username].friendRequests || [];
        let sentRequests = usersData[username].sentRequests || [];

        // Bildirim göster
        function showNotification(message, type = 'success') {
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Modal göster
        function showModal(message, confirmCallback) {
            modalMessage.textContent = message;
            userSearchModal.style.display = 'flex';
            
            modalConfirm.onclick = function() {
                confirmCallback();
                userSearchModal.style.display = 'none';
            };
        }

        // Modal'ı kapat
        function closeModalFunc() {
            userSearchModal.style.display = 'none';
        }

        closeModal.addEventListener('click', closeModalFunc);
        modalCancel.addEventListener('click', closeModalFunc);

        // Arkadaş listesini güncelle
        function updateFriendsList() {
            friendsList.innerHTML = '';
            
            if (friends.length === 0) {
                friendsList.innerHTML = `
                    <div class="empty-state">
                        <div><i class="fas fa-user-friends"></i></div>
                        <p>Henüz arkadaş eklemediniz</p>
                    </div>
                `;
                return;
            }
            
            friends.forEach(friend => {
                const li = document.createElement("li");
                if (friend === currentFriend) {
                    li.classList.add('active');
                }
                
                li.innerHTML = `
                    <div class="friend-info">
                        <div class="friend-avatar">${friend.charAt(0).toUpperCase()}</div>
                        ${friend}
                    </div>
                    <div class="friend-actions">
                        <span class="friend-status"></span>
                        <button class="remove-friend" data-user="${friend}" title="Arkadaşı Sil">
                            <i class="fas fa-user-times"></i>
                        </button>
                    </div>
                `;
                
                li.addEventListener("click", (e) => {
                    // Sadece arkadaş adına tıklanırsa sohbeti aç
                    if (!e.target.closest('.remove-friend')) {
                        window.location.href = `?username=${username}&friend=${friend}`;
                    }
                });
                
                // Silme butonuna event listener ekle
                const removeBtn = li.querySelector('.remove-friend');
                removeBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Üst elementlere eventin yayılmasını engelle
                    removeFriend(friend);
                });
                
                friendsList.appendChild(li);
            });
        }

        // Arkadaş silme fonksiyonu
        function removeFriend(friendUsername) {
            if (!confirm(`${friendUsername} kullanıcısını arkadaş listenizden silmek istediğinize emin misiniz?`)) {
                return;
            }
            
            // Kendi arkadaş listemizden sil
            const index = friends.indexOf(friendUsername);
            if (index > -1) {
                friends.splice(index, 1);
            }
            
            // Karşı taraftan da bizi silmesi için veriyi güncelle
            if (usersData[friendUsername]) {
                const friendIndex = usersData[friendUsername].friends.indexOf(username);
                if (friendIndex > -1) {
                    usersData[friendUsername].friends.splice(friendIndex, 1);
                }
            }
            
            // Eğer şu an silinen arkadaşla sohbet ediliyorsa, sohbeti kapat
            if (currentFriend === friendUsername) {
                currentFriend = null;
                chatHeader.textContent = 'Sohbet Başlat';
                // URL'den friend parametresini kaldır
                window.history.replaceState({}, '', `?username=${username}`);
            }
            
            // LocalStorage'ı güncelle
            localStorage.setItem('usersData', JSON.stringify(usersData));
            
            // Listeleri yenile
            updateFriendsList();
            loadMessages();
            
            showNotification(`${friendUsername} arkadaş listesinden silindi.`);
        }

        // İstek listesini güncelle
        function updateRequestsList() {
            requestsList.innerHTML = '';
            
            if (friendRequests.length === 0) {
                requestsList.innerHTML = `
                    <div class="empty-state">
                        <p>Henüz arkadaşlık isteği yok</p>
                    </div>
                `;
                return;
            }
            
            friendRequests.forEach(request => {
                const li = document.createElement("li");
                li.className = 'request-item';
                li.innerHTML = `
                    <div class="friend-info">
                        <div class="friend-avatar">${request.charAt(0).toUpperCase()}</div>
                        ${request}
                    </div>
                    <div class="request-actions">
                        <button class="accept-btn" data-user="${request}"><i class="fas fa-check"></i></button>
                        <button class="reject-btn" data-user="${request}"><i class="fas fa-times"></i></button>
                    </div>
                `;
                
                requestsList.appendChild(li);
            });
            
            // Kabul ve reddetme butonlarına event listener ekle
            document.querySelectorAll('.accept-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const requestUser = e.target.closest('button').dataset.user;
                    acceptFriendRequest(requestUser);
                });
            });
            
            document.querySelectorAll('.reject-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const requestUser = e.target.closest('button').dataset.user;
                    rejectFriendRequest(requestUser);
                });
            });
        }

        // Arkadaşlık isteğini kabul et
        function acceptFriendRequest(requestUser) {
            // İsteği kaldır
            const requestIndex = friendRequests.indexOf(requestUser);
            if (requestIndex > -1) {
                friendRequests.splice(requestIndex, 1);
            }
            
            // Arkadaş ekle
            if (!friends.includes(requestUser)) {
                friends.push(requestUser);
            }
            
            // Karşı tarafa da ekle
            if (usersData[requestUser]) {
                if (!usersData[requestUser].friends.includes(username)) {
                    usersData[requestUser].friends.push(username);
                }
                
                // Gönderilen isteği kaldır
                const sentIndex = usersData[requestUser].sentRequests.indexOf(username);
                if (sentIndex > -1) {
                    usersData[requestUser].sentRequests.splice(sentIndex, 1);
                }
            }
            
            // Verileri güncelle
            usersData[username].friendRequests = friendRequests;
            usersData[username].friends = friends;
            
            // LocalStorage'ı güncelle
            localStorage.setItem('usersData', JSON.stringify(usersData));
            
            showNotification(`${requestUser} arkadaş listenize eklendi`);
            updateFriendsList();
            updateRequestsList();
        }

        // Arkadaşlık isteğini reddet
        function rejectFriendRequest(requestUser) {
            // İsteği kaldır
            const requestIndex = friendRequests.indexOf(requestUser);
            if (requestIndex > -1) {
                friendRequests.splice(requestIndex, 1);
            }
            
            // Karşı taraftaki gönderilen isteği kaldır
            if (usersData[requestUser]) {
                const sentIndex = usersData[requestUser].sentRequests.indexOf(username);
                if (sentIndex > -1) {
                    usersData[requestUser].sentRequests.splice(sentIndex, 1);
                }
            }
            
            // Verileri güncelle
            usersData[username].friendRequests = friendRequests;
            
            // LocalStorage'ı güncelle
            localStorage.setItem('usersData', JSON.stringify(usersData));
            
            showNotification(`${requestUser} isteği reddedildi`);
            updateRequestsList();
        }

        // Kullanıcı var mı kontrol et
        function checkUserExists(user) {
            return usersData.hasOwnProperty(user);
        }

        // Arkadaşlık isteği gönder
        function sendFriendRequest() {
            const friendUsername = friendUsernameInput.value.trim();
            
            if (!friendUsername) {
                showNotification("Lütfen bir kullanıcı adı girin", "error");
                return;
            }
            
            if (friendUsername === username) {
                showNotification("Kendinize istek gönderemezsiniz", "error");
                return;
            }
            
            if (friends.includes(friendUsername)) {
                showNotification("Bu kullanıcı zaten arkadaş listenizde", "error");
                return;
            }
            
            if (sentRequests.includes(friendUsername)) {
                showNotification("Bu kullanıcıya zaten istek gönderdiniz", "error");
                return;
            }
            
            // Kullanıcı var mı kontrol et
            if (!checkUserExists(friendUsername)) {
                showModal("Bu kullanıcı adına sahip birisi bulunamadı. Yine de istek göndermek istiyor musunuz?", () => {
                    // Kullanıcı onaylarsa istek gönder
                    actuallySendRequest(friendUsername);
                });
                return;
            }
            
            // Kullanıcı varsa direkt istek gönder
            actuallySendRequest(friendUsername);
        }

        // İstek gönderme işlemi
        function actuallySendRequest(friendUsername) {
            // Gönderilen isteklere ekle
            if (!sentRequests.includes(friendUsername)) {
                sentRequests.push(friendUsername);
                usersData[username].sentRequests = sentRequests;
            }
            
            // Karşı tarafın gelen isteklerine ekle (eğer kullanıcı varsa)
            if (usersData[friendUsername]) {
                if (!usersData[friendUsername].friendRequests) {
                    usersData[friendUsername].friendRequests = [];
                }
                
                if (!usersData[friendUsername].friendRequests.includes(username)) {
                    usersData[friendUsername].friendRequests.push(username);
                }
            }
            
            // LocalStorage'ı güncelle
            localStorage.setItem('usersData', JSON.stringify(usersData));
            
            showNotification(`${friendUsername} kullanıcısına istek gönderildi`);
            friendUsernameInput.value = '';
            
            // İstek listesini güncelle
            if (usersData[friendUsername]) {
                updateRequestsList();
            }
        }

        // Mesajları yükle
        function loadMessages() {
            messagesDiv.innerHTML = '';
            
            if (!currentFriend) {
                emptyState.style.display = 'flex';
                return;
            }
            
            emptyState.style.display = 'none';
            
            // Mevcut kullanıcının mesajlarını al
            const userMessages = usersData[username]?.messages[currentFriend] || [];
            // Arkadaşın mesajlarını al (karşı taraftan gelen mesajlar)
            const friendMessages = usersData[currentFriend]?.messages[username] || [];
            
            // Tüm mesajları birleştir ve zamanına göre sırala
            const allMessages = [...userMessages, ...friendMessages];
            allMessages.sort((a, b) => a.time - b.time);
            
            if (allMessages.length === 0) {
                messagesDiv.innerHTML = `
                    <div class="empty-state">
                        <div><i class="fas fa-comment-slash"></i></div>
                        <p>Bu sohbette henüz mesaj yok</p>
                        <p>İlk mesajı göndererek sohbeti başlatın!</p>
                    </div>
                `;
                return;
            }
            
            allMessages.forEach(msg => {
                const messageElement = document.createElement("div");
                messageElement.classList.add("message");
                
                if (msg.sender === username) {
                    messageElement.classList.add("sent");
                } else {
                    messageElement.classList.add("received");
                }
                
                const messageTime = new Date(msg.time).toLocaleTimeString('tr-TR', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                messageElement.innerHTML = `
                    <div class="message-content">${msg.message}</div>
                    <div class="message-info">
                        <span>${msg.sender === username ? 'Sen' : msg.sender}</span>
                        <span>${messageTime}</span>
                    </div>
                `;
                
                messagesDiv.appendChild(messageElement);
            });
            
            // En son mesaja kaydır
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Mesaj gönderme
        function sendMessage() {
            const messageText = messageInput.value.trim();
            
            if (!messageText) {
                showNotification("Lütfen bir mesaj yazın", "error");
                return;
            }
            
            if (!currentFriend) {
                showNotification("Önce bir arkadaş seçmelisiniz", "error");
                return;
            }
            
            const timestamp = new Date().getTime();
            const messageData = {
                sender: username,
                message: messageText,
                time: timestamp
            };
            
            // Mevcut kullanıcının mesajlarını güncelle
            if (!usersData[username].messages[currentFriend]) {
                usersData[username].messages[currentFriend] = [];
            }
            usersData[username].messages[currentFriend].push(messageData);
            
            // Arkadaşın mesajlarını güncelle (karşı tarafın verileri)
            if (!usersData[currentFriend]) {
                usersData[currentFriend] = { 
                    friends: [], 
                    messages: {}, 
                    friendRequests: [],
                    sentRequests: []
                };
            }
            
            if (!usersData[currentFriend].messages[username]) {
                usersData[currentFriend].messages[username] = [];
            }
            usersData[currentFriend].messages[username].push(messageData);
            
            // LocalStorage'ı güncelle
            localStorage.setItem('usersData', JSON.stringify(usersData));
            
            // Mesaj kutusunu temizle ve mesajları yenile
            messageInput.value = '';
            loadMessages();
        }

        // Sohbeti temizleme
        clearChatButton.addEventListener("click", () => {
            if (!currentFriend) {
                showNotification("Önce bir arkadaş seçmelisiniz", "error");
                return;
            }
            
            if (confirm("Bu sohbeti temizlemek istediğinize emin misiniz? Bu işlem geri alınamaz.")) {
                // Mevcut kullanıcının mesajlarını temizle
                if (usersData[username].messages[currentFriend]) {
                    usersData[username].messages[currentFriend] = [];
                }
                
                // Arkadaşın mesajlarını temizle
                if (usersData[currentFriend] && usersData[currentFriend].messages[username]) {
                    usersData[currentFriend].messages[username] = [];
                }
                
                // LocalStorage'ı güncelle
                localStorage.setItem('usersData', JSON.stringify(usersData));
                
                showNotification("Sohbet temizlendi");
                loadMessages();
            }
        });

        // Sayfayı yenileme
        refreshButton.addEventListener("click", () => {
            usersData = JSON.parse(localStorage.getItem('usersData')) || {};
            updateFriendsList();
            updateRequestsList();
            loadMessages();
            showNotification("Sayfa yenilendi");
        });

        // Enter tuşu ile mesaj gönderme
        messageInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        sendButton.addEventListener("click", sendMessage);
        addFriendButton.addEventListener("click", sendFriendRequest);

        // Sayfa yüklendiğinde
        window.onload = () => {
            updateFriendsList();
            updateRequestsList();
            loadMessages();
            
            // URL'de arkadaş parametresi varsa başlığı güncelle
            if (currentFriend) {
                chatHeader.textContent = `Sohbet: ${currentFriend}`;
            }
        };
    </script>
</body>
</html>
